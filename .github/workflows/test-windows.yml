name: Windows Test

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    paths:
      - 'mrblib/**'
      - '.github/workflows/test-windows.yml'

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Cache Zig
      uses: actions/cache@v4
      with:
        path: C:\zig
        key: windows-zig-0.10.1

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
          C:\vcpkg\downloads
        key: windows-vcpkg-x86_64-${{ hashFiles('build_config.rb', 'mrbgem.rake') }}

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: Setup Zig
      run: |
        $ZigVersion = "0.10.1"
        $ZigPath = "C:\zig\zig-windows-x86_64-$ZigVersion"
        if (-Not (Test-Path "$ZigPath\zig.exe")) {
          Invoke-WebRequest -Uri "https://ziglang.org/download/$ZigVersion/zig-windows-x86_64-$ZigVersion.zip" -OutFile zig.zip
          Expand-Archive -Path zig.zip -DestinationPath C:\zig
        }
        echo "C:\zig\zig-windows-x86_64-$ZigVersion" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install dependencies
      run: |
        gem install rake
        choco install mingw -y --force

        # Install pkg-config for library detection
        # Use vcpkg to install pkgconf (provides pkg-config.exe)
        if (Test-Path "C:\vcpkg\vcpkg.exe") {
          C:\vcpkg\vcpkg.exe install pkgconf:x64-windows
          # Add vcpkg tools to PATH (contains pkgconf's pkg-config.exe)
          $vcpkgRoot = "C:\vcpkg"
          $toolsPath = Join-Path $vcpkgRoot "installed\x64-windows\tools\pkgconf"
          if (Test-Path $toolsPath) {
            echo "$toolsPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }
        } else {
          Write-Host "vcpkg not found, pkg-config may not be available"
        }

        # Install oniguruma for mruby-onig-regexp
        # Try vcpkg first, fall back to building from source if needed
        if (Test-Path "C:\vcpkg\vcpkg.exe") {
          C:\vcpkg\vcpkg.exe install oniguruma:x64-windows
        } else {
          Write-Host "vcpkg not found, trying Chocolatey..."
          choco install oniguruma -y --force 2>&1 | Out-Null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Oniguruma not available via package manager, mruby will bundle it"
          }
        }

    - name: Build mitamae
      env:
        MRUBY_YAML_USE_SYSTEM_LIBRARY: 1
        PKG_CONFIG_PATH: "C:/vcpkg/packages/oniguruma_x64-windows/lib/pkgconfig;C:/vcpkg/installed/x64-windows/lib/pkgconfig"
      run: |
        # Create junction on same drive to shorten paths for Windows command line limits
        $currentDir = (Get-Location).Path
        $drive = $currentDir.Substring(0, 1)
        $shortPath = "$drive`:\m"
        if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        New-Item -ItemType Junction -Path $shortPath -Target $currentDir

        try {
          # Build from shortened path to reduce command line length
          Set-Location $shortPath
          rake "release:build:windows-x86_64"
        } finally {
          # Clean up junction
          Set-Location $currentDir
          if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        }

    - name: Create comprehensive test recipe
      run: |
        @"
        # Basic resource tests
        execute 'echo Hello from Windows' do
          command 'echo Hello from Windows'
        end

        # Package management tests
        package 'notepad++' do
          action :install
        end

        # File system tests
        directory 'C:\mitamae_test' do
          action :create
        end

        file 'C:\mitamae_test\test.txt' do
          content 'This is a test file created by mitamae'
        end

        # Template test
        template 'C:\mitamae_test\template.txt' do
          source 'templates/hello.erb'
          variables message: 'Hello from Windows template'
        end

        # Link test
        file 'C:\mitamae_test\source.txt' do
          content 'Source file for link'
        end

        link 'C:\mitamae_test\link.txt' do
          to 'C:\mitamae_test\source.txt'
        end

        # Execute with guard conditions
        execute 'conditional command' do
          command 'echo This command runs'
          only_if 'echo Condition is true'
        end

        execute 'skipped command' do
          command 'echo This should not run'
          not_if 'echo Condition is true'
        end

        # Service test (read-only, doesn't modify services)
        service 'W32Time' do
          action :nothing
        end
        "@ | Out-File -FilePath windows_test.rb -Encoding utf8

    - name: Create template file
      run: |
        @"
        <%= @message %>
        Generated at: <%= Time.now %>
        "@ | Out-File -FilePath templates/hello.erb -Encoding utf8

    - name: Run comprehensive test recipe
      run: |
        .\mitamae-build\mitamae-x86_64-windows.exe local -l debug windows_test.rb

    - name: Verify test results
      run: |
        # Check if directory was created
        if (Test-Path 'C:\mitamae_test') {
          Write-Host "✓ Directory created successfully"
        } else {
          Write-Host "✗ Directory not created"
          exit 1
        }

        # Check if file was created
        if (Test-Path 'C:\mitamae_test\test.txt') {
          Write-Host "✓ File created successfully"
          Get-Content 'C:\mitamae_test\test.txt'
        } else {
          Write-Host "✗ File not created"
          exit 1
        }

        # Check if link was created
        if (Test-Path 'C:\mitamae_test\link.txt') {
          Write-Host "✓ Link created successfully"
        } else {
          Write-Host "✗ Link not created"
        }

        # Clean up
        Remove-Item -Recurse -Force 'C:\mitamae_test' -ErrorAction SilentlyContinue

    - name: Run mruby gem compatibility test
      run: |
        .\mitamae-build\mitamae-x86_64-windows.exe local -l info spec/windows/gem_compatibility_test.rb

    - name: Run Windows path compatibility test
      run: |
        .\mitamae-build\mitamae-x86_64-windows.exe local -l info spec/recipes/windows_path_test.rb
