name: Windows Package Manager Test

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'mrblib/mitamae/resource_executor/package.rb'
      - '.github/workflows/windows-package-test.yml'
      - 'spec/windows/**'

jobs:
  test-chocolatey:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Restore Zig cache
      id: cache-zig
      uses: actions/cache/restore@v4
      with:
        path: C:\zig
        key: windows-zig-0.10.1

    - name: Restore vcpkg cache
      id: cache-vcpkg
      uses: actions/cache/restore@v4
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
          C:\vcpkg\downloads
        key: windows-vcpkg-x86_64-${{ hashFiles('build_config.rb', 'mrbgem.rake') }}
        restore-keys: |
          windows-vcpkg-x86_64-

    - name: Restore Ruby cache
      id: cache-ruby
      uses: actions/cache/restore@v4
      with:
        path: |
          C:\hostedtoolcache\windows\Ruby\3.1.*\x64
          C:\hostedtoolcache\windows\Ruby\3.1.*\x86
        key: windows-ruby-3.1
    - name: Restore Oniguruma cache
      id: cache-oniguruma
      uses: actions/cache/restore@v4
      with:
        path: C:\oniguruma\windows-x86_64
        key: windows-oniguruma-6.9.9-windows-x86_64

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: Setup Zig
      run: |
        $ZigVersion = "0.10.1"
        $ZigPath = "C:\zig\zig-windows-x86_64-$ZigVersion"
        if (-Not (Test-Path "$ZigPath\zig.exe")) {
          Invoke-WebRequest -Uri "https://ziglang.org/download/$ZigVersion/zig-windows-x86_64-$ZigVersion.zip" -OutFile zig.zip
          Expand-Archive -Path zig.zip -DestinationPath C:\zig
        }
        echo "C:\zig\zig-windows-x86_64-$ZigVersion" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install dependencies
      run: |
        gem install rake
        if (-not (Get-Command ninja -ErrorAction SilentlyContinue)) {
          choco install ninja -y --force
        }

        # Install pkg-config for library detection
        # Use vcpkg to install pkgconf (provides pkg-config.exe)
        if (Test-Path "C:\vcpkg\vcpkg.exe") {
          C:\vcpkg\vcpkg.exe install pkgconf:x64-windows
          C:\vcpkg\vcpkg.exe install libyaml:x64-windows
          $toolsPath = "C:\vcpkg\installed\x64-windows\tools\pkgconf"
          if (Test-Path $toolsPath) {
            echo "$toolsPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }
        } else {
          Write-Host "vcpkg not found, pkg-config may not be available"
        }

    - name: Build Oniguruma (Zig)
      run: |
        $version = "6.9.9"
        $target = "x86_64-windows-gnu"
        $prefix = "C:\oniguruma\windows-x86_64"
        $libPath = Join-Path $prefix "lib\libonig.a"

        if (Test-Path $libPath) {
          Write-Host "Oniguruma already cached at $libPath"
          exit 0
        }

        $srcRoot = Join-Path $env:RUNNER_TEMP "oniguruma-src"
        $archive = Join-Path $env:RUNNER_TEMP "oniguruma-$version.tar.gz"
        $url = "https://github.com/kkos/oniguruma/archive/refs/tags/v$version.tar.gz"
        $tar = Join-Path $env:WINDIR "System32\\tar.exe"

        if (Test-Path $srcRoot) { Remove-Item -Recurse -Force $srcRoot }
        New-Item -ItemType Directory -Path $srcRoot | Out-Null

        Invoke-WebRequest -Uri $url -OutFile $archive
        & $tar -xzf $archive -C $srcRoot

        $srcDir = Join-Path $srcRoot "oniguruma-$version"
        $buildDir = Join-Path $srcRoot "build"
        New-Item -ItemType Directory -Force -Path $buildDir | Out-Null

        cmake -S $srcDir -B $buildDir -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_INSTALL_PREFIX="C:/oniguruma/windows-x86_64" `
          -DCMAKE_C_COMPILER=zig `
          -DCMAKE_C_COMPILER_ARG1="cc --target=$target"

        cmake --build $buildDir --target install --config Release

        $pkgDir = Join-Path $prefix "lib\pkgconfig"
        New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
        $prefixPc = $prefix -replace '\\','/'
        @"
        prefix=$prefixPc
        exec_prefix=$prefixPc
        libdir=$prefixPc/lib
        includedir=$prefixPc/include

        Name: oniguruma
        Description: Oniguruma Regular Expressions
        Version: $version
        Libs: -L$prefixPc/lib -lonig
        Cflags: -I$prefixPc/include
        "@ | Out-File -FilePath (Join-Path $pkgDir "oniguruma.pc") -Encoding ascii

    - name: Build mitamae
      env:
        MRUBY_YAML_USE_SYSTEM_LIBRARY: 1
        ONIGURUMA_PREFIX: "C:/oniguruma/windows-x86_64"
        VCPKG_ROOT: "C:/vcpkg"
        PKG_CONFIG_PATH: "C:/oniguruma/windows-x86_64/lib/pkgconfig;C:/vcpkg/installed/x64-windows/lib/pkgconfig"
      run: |
        rake "release:build:windows-x86_64"

    - name: Test Chocolatey package installation
      run: |
        # Create test recipe for Chocolatey
        @"
        # Test Chocolatey package installation
        package 'git' do
          action :install
        end

        # Test package removal
        package 'git' do
          action :remove
        end

        # Test package with version
        package 'notepad++' do
          version '8.4.7'
          action :install
        end

        # Test package with options
        package 'curl' do
          options '--force'
          action :install
        end
        "@ | Out-File -FilePath chocolatey_test.rb -Encoding utf8

        # Run test
        .\mitamae-build\mitamae-x86_64-windows.exe local -l debug chocolatey_test.rb

        # Verify installations
        if (choco list --local-only | Select-String 'notepad\+\+') {
          Write-Host "✓ notepad++ installed via Chocolatey"
        } else {
          Write-Host "✗ notepad++ not installed"
        }

        if (choco list --local-only | Select-String 'curl') {
          Write-Host "✓ curl installed via Chocolatey"
        } else {
          Write-Host "✗ curl not installed"
        }

        # Clean up
        $packages = @('notepad++', 'curl')
        foreach ($pkg in $packages) {
          if (choco list --local-only --exact $pkg | Select-String -Pattern ("^" + [regex]::Escape($pkg) + "(\\s|\\|)")) {
            choco uninstall $pkg -y
          } else {
            Write-Host "Skipping uninstall for $pkg (not installed)"
          }
        }

    - name: Save Zig cache
      if: always() && steps.cache-zig.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: C:\zig
        key: ${{ steps.cache-zig.outputs.cache-primary-key }}

    - name: Save vcpkg cache
      if: always() && steps.cache-vcpkg.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
          C:\vcpkg\downloads
        key: ${{ steps.cache-vcpkg.outputs.cache-primary-key }}

    - name: Save Ruby cache
      if: always() && steps.cache-ruby.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          C:\hostedtoolcache\windows\Ruby\3.1.*\x64
          C:\hostedtoolcache\windows\Ruby\3.1.*\x86
        key: ${{ steps.cache-ruby.outputs.cache-primary-key }}

    - name: Save Oniguruma cache
      if: always() && steps.cache-oniguruma.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: C:\oniguruma\windows-x86_64
        key: ${{ steps.cache-oniguruma.outputs.cache-primary-key }}

  test-winget:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Restore Zig cache
      id: cache-zig
      uses: actions/cache/restore@v4
      with:
        path: C:\zig
        key: windows-zig-0.10.1

    - name: Restore vcpkg cache
      id: cache-vcpkg
      uses: actions/cache/restore@v4
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
          C:\vcpkg\downloads
        key: windows-vcpkg-x86_64-${{ hashFiles('build_config.rb', 'mrbgem.rake') }}
        restore-keys: |
          windows-vcpkg-x86_64-

    - name: Restore Ruby cache
      id: cache-ruby
      uses: actions/cache/restore@v4
      with:
        path: |
          C:\hostedtoolcache\windows\Ruby\3.1.*\x64
          C:\hostedtoolcache\windows\Ruby\3.1.*\x86
        key: windows-ruby-3.1

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: Setup Zig
      run: |
        $ZigVersion = "0.10.1"
        $ZigPath = "C:\zig\zig-windows-x86_64-$ZigVersion"
        if (-Not (Test-Path "$ZigPath\zig.exe")) {
          Invoke-WebRequest -Uri "https://ziglang.org/download/$ZigVersion/zig-windows-x86_64-$ZigVersion.zip" -OutFile zig.zip
          Expand-Archive -Path zig.zip -DestinationPath C:\zig
        }
        echo "C:\zig\zig-windows-x86_64-$ZigVersion" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install dependencies
      run: |
        gem install rake
        if (-not (Get-Command ninja -ErrorAction SilentlyContinue)) {
          choco install ninja -y --force
        }

        # Install pkg-config for library detection
        # Use vcpkg to install pkgconf (provides pkg-config.exe)
        if (Test-Path "C:\vcpkg\vcpkg.exe") {
          C:\vcpkg\vcpkg.exe install pkgconf:x64-windows
          C:\vcpkg\vcpkg.exe install libyaml:x64-windows
          $toolsPath = "C:\vcpkg\installed\x64-windows\tools\pkgconf"
          if (Test-Path $toolsPath) {
            echo "$toolsPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }
        } else {
          Write-Host "vcpkg not found, pkg-config may not be available"
        }

    - name: Build Oniguruma (Zig)
      run: |
        $version = "6.9.9"
        $target = "x86_64-windows-gnu"
        $prefix = "C:\oniguruma\windows-x86_64"
        $libPath = Join-Path $prefix "lib\libonig.a"

        if (Test-Path $libPath) {
          Write-Host "Oniguruma already cached at $libPath"
          exit 0
        }

        $srcRoot = Join-Path $env:RUNNER_TEMP "oniguruma-src"
        $archive = Join-Path $env:RUNNER_TEMP "oniguruma-$version.tar.gz"
        $url = "https://github.com/kkos/oniguruma/archive/refs/tags/v$version.tar.gz"
        $tar = Join-Path $env:WINDIR "System32\\tar.exe"

        if (Test-Path $srcRoot) { Remove-Item -Recurse -Force $srcRoot }
        New-Item -ItemType Directory -Path $srcRoot | Out-Null

        Invoke-WebRequest -Uri $url -OutFile $archive
        & $tar -xzf $archive -C $srcRoot

        $srcDir = Join-Path $srcRoot "oniguruma-$version"
        $buildDir = Join-Path $srcRoot "build"
        New-Item -ItemType Directory -Force -Path $buildDir | Out-Null

        cmake -S $srcDir -B $buildDir -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_INSTALL_PREFIX="C:/oniguruma/windows-x86_64" `
          -DCMAKE_C_COMPILER=zig `
          -DCMAKE_C_COMPILER_ARG1="cc --target=$target"

        cmake --build $buildDir --target install --config Release

        $pkgDir = Join-Path $prefix "lib\pkgconfig"
        New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
        $prefixPc = $prefix -replace '\\','/'
        @"
        prefix=$prefixPc
        exec_prefix=$prefixPc
        libdir=$prefixPc/lib
        includedir=$prefixPc/include

        Name: oniguruma
        Description: Oniguruma Regular Expressions
        Version: $version
        Libs: -L$prefixPc/lib -lonig
        Cflags: -I$prefixPc/include
        "@ | Out-File -FilePath (Join-Path $pkgDir "oniguruma.pc") -Encoding ascii

    - name: Build mitamae
      env:
        MRUBY_YAML_USE_SYSTEM_LIBRARY: 1
        ONIGURUMA_PREFIX: "C:/oniguruma/windows-x86_64"
        VCPKG_ROOT: "C:/vcpkg"
        PKG_CONFIG_PATH: "C:/oniguruma/windows-x86_64/lib/pkgconfig;C:/vcpkg/installed/x64-windows/lib/pkgconfig"
      run: |
        # Create junction on same drive to shorten paths for Windows command line limits
        $currentDir = (Get-Location).Path
        $drive = $currentDir.Substring(0, 1)
        $shortPath = "$drive`:\m"
        if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        New-Item -ItemType Junction -Path $shortPath -Target $currentDir

        try {
          # Build from shortened path to reduce command line length
          Set-Location $shortPath
          rake "release:build:windows-x86_64"
        } finally {
          # Clean up junction
          Set-Location $currentDir
          if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        }

    - name: Remove Chocolatey to test winget fallback
      run: |
        # Temporarily rename choco.exe to test winget fallback
        Rename-Item "C:\ProgramData\chocolatey\bin\choco.exe" "C:\ProgramData\chocolatey\bin\choco.exe.bak" -ErrorAction SilentlyContinue

    - name: Test winget package installation
      run: |
        # Check if winget is available
        if (Get-Command winget -ErrorAction SilentlyContinue) {
          Write-Host "✓ winget is available"

          # Create test recipe for winget
          @(
            "# Test winget package installation (when Chocolatey not available)",
            "package 'Microsoft.PowerShell' do",
            "  action :install",
            "end"
          ) -join "`n" | Out-File -FilePath winget_test.rb -Encoding utf8

          # Run test
          .\mitamae-build\mitamae-x86_64-windows.exe local -l debug winget_test.rb

          # Verify installation
          if (winget list --name PowerShell | Select-String 'Microsoft.PowerShell') {
            Write-Host "✓ PowerShell installed via winget"
          } else {
            Write-Host "✗ PowerShell not installed"
          }
        } else {
          Write-Host "⚠ winget not available, skipping winget tests"
        }

    - name: Restore Chocolatey
      run: |
        # Restore choco.exe
        Rename-Item "C:\ProgramData\chocolatey\bin\choco.exe.bak" "C:\ProgramData\chocolatey\bin\choco.exe" -ErrorAction SilentlyContinue

    - name: Save Zig cache
      if: always() && steps.cache-zig.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: C:\zig
        key: ${{ steps.cache-zig.outputs.cache-primary-key }}

    - name: Save vcpkg cache
      if: always() && steps.cache-vcpkg.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
          C:\vcpkg\downloads
        key: ${{ steps.cache-vcpkg.outputs.cache-primary-key }}

    - name: Save Ruby cache
      if: always() && steps.cache-ruby.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          C:\hostedtoolcache\windows\Ruby\3.1.*\x64
          C:\hostedtoolcache\windows\Ruby\3.1.*\x86
        key: ${{ steps.cache-ruby.outputs.cache-primary-key }}

  test-no-package-manager:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Restore Ruby cache
      id: cache-ruby
      uses: actions/cache/restore@v4
      with:
        path: |
          C:\hostedtoolcache\windows\Ruby\3.1.*\x64
          C:\hostedtoolcache\windows\Ruby\3.1.*\x86
        key: windows-ruby-3.1
    - name: Restore Oniguruma cache
      id: cache-oniguruma
      uses: actions/cache/restore@v4
      with:
        path: C:\oniguruma\windows-x86_64
        key: windows-oniguruma-6.9.9-windows-x86_64

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: Setup Zig
      run: |
        $ZigVersion = "0.10.1"
        Invoke-WebRequest -Uri "https://ziglang.org/download/$ZigVersion/zig-windows-x86_64-$ZigVersion.zip" -OutFile zig.zip
        Expand-Archive -Path zig.zip -DestinationPath C:\zig
        echo "C:\zig\zig-windows-x86_64-$ZigVersion" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: Install dependencies
      run: |
        gem install rake
        if (-not (Get-Command ninja -ErrorAction SilentlyContinue)) {
          choco install ninja -y --force
        }

        # Install pkg-config for library detection
        # Use vcpkg to install pkgconf (provides pkg-config.exe)
        if (Test-Path "C:\vcpkg\vcpkg.exe") {
          C:\vcpkg\vcpkg.exe install pkgconf:x64-windows
          C:\vcpkg\vcpkg.exe install libyaml:x64-windows
          $toolsPath = "C:\vcpkg\installed\x64-windows\tools\pkgconf"
          if (Test-Path $toolsPath) {
            echo "$toolsPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }
        } else {
          Write-Host "vcpkg not found, pkg-config may not be available"
        }

    - name: Build Oniguruma (Zig)
      run: |
        $version = "6.9.9"
        $target = "x86_64-windows-gnu"
        $prefix = "C:\oniguruma\windows-x86_64"
        $libPath = Join-Path $prefix "lib\libonig.a"

        if (Test-Path $libPath) {
          Write-Host "Oniguruma already cached at $libPath"
          exit 0
        }

        $srcRoot = Join-Path $env:RUNNER_TEMP "oniguruma-src"
        $archive = Join-Path $env:RUNNER_TEMP "oniguruma-$version.tar.gz"
        $url = "https://github.com/kkos/oniguruma/archive/refs/tags/v$version.tar.gz"
        $tar = Join-Path $env:WINDIR "System32\\tar.exe"

        if (Test-Path $srcRoot) { Remove-Item -Recurse -Force $srcRoot }
        New-Item -ItemType Directory -Path $srcRoot | Out-Null

        Invoke-WebRequest -Uri $url -OutFile $archive
        & $tar -xzf $archive -C $srcRoot

        $srcDir = Join-Path $srcRoot "oniguruma-$version"
        $buildDir = Join-Path $srcRoot "build"
        New-Item -ItemType Directory -Force -Path $buildDir | Out-Null

        cmake -S $srcDir -B $buildDir -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_INSTALL_PREFIX="C:/oniguruma/windows-x86_64" `
          -DCMAKE_C_COMPILER=zig `
          -DCMAKE_C_COMPILER_ARG1="cc --target=$target"

        cmake --build $buildDir --target install --config Release

        $pkgDir = Join-Path $prefix "lib\pkgconfig"
        New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
        $prefixPc = $prefix -replace '\\','/'
        @"
        prefix=$prefixPc
        exec_prefix=$prefixPc
        libdir=$prefixPc/lib
        includedir=$prefixPc/include

        Name: oniguruma
        Description: Oniguruma Regular Expressions
        Version: $version
        Libs: -L$prefixPc/lib -lonig
        Cflags: -I$prefixPc/include
        "@ | Out-File -FilePath (Join-Path $pkgDir "oniguruma.pc") -Encoding ascii

    - name: Build mitamae
      env:
        MRUBY_YAML_USE_SYSTEM_LIBRARY: 1
        ONIGURUMA_PREFIX: "C:/oniguruma/windows-x86_64"
        VCPKG_ROOT: "C:/vcpkg"
        PKG_CONFIG_PATH: "C:/oniguruma/windows-x86_64/lib/pkgconfig;C:/vcpkg/installed/x64-windows/lib/pkgconfig"
      run: |
        # Create junction on same drive to shorten paths for Windows command line limits
        $currentDir = (Get-Location).Path
        $drive = $currentDir.Substring(0, 1)
        $shortPath = "$drive`:\m"
        if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        New-Item -ItemType Junction -Path $shortPath -Target $currentDir

        try {
          # Build from shortened path to reduce command line length
          Set-Location $shortPath
          rake "release:build:windows-x86_64"
        } finally {
          # Clean up junction
          Set-Location $currentDir
          if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        }


    - name: Disable package managers to test fallback
      run: |
        # Temporarily disable both package managers
        Rename-Item "C:\ProgramData\chocolatey\bin\choco.exe" "C:\ProgramData\chocolatey\bin\choco.exe.bak" -ErrorAction SilentlyContinue
        if (Test-Path "C:\Program Files\WindowsApps\Microsoft.DesktopAppInstaller_*") {
          # winget is in WindowsApps which requires special permissions to modify
          Write-Host "⚠ Cannot rename winget (protected folder), will rely on command check"
        }

    - name: Test package manager fallback
      run: |
        # Create test recipe that should fall back to specinfra
        @(
          "# This should fall back to specinfra when no package manager is available",
          "package 'nonexistentpackage' do",
          "  action :install",
          "end"
        ) -join "`n" | Out-File -FilePath fallback_test.rb -Encoding utf8

        # Run test - should fail gracefully
        .\mitamae-build\mitamae-x86_64-windows.exe local -l error fallback_test.rb
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✓ Package resource handled fallback gracefully"
        } else {
          Write-Host "⚠ Package resource failed (expected when no package manager available)"
        }
        exit 0

    - name: Restore package managers
      run: |
        # Restore choco.exe
        Rename-Item "C:\ProgramData\chocolatey\bin\choco.exe.bak" "C:\ProgramData\chocolatey\bin\choco.exe" -ErrorAction SilentlyContinue

    - name: Save Ruby cache
      if: always() && steps.cache-ruby.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          C:\hostedtoolcache\windows\Ruby\3.1.*\x64
          C:\hostedtoolcache\windows\Ruby\3.1.*\x86
        key: ${{ steps.cache-ruby.outputs.cache-primary-key }}

    - name: Save Oniguruma cache
      if: always() && steps.cache-oniguruma.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: C:\oniguruma\windows-x86_64
        key: ${{ steps.cache-oniguruma.outputs.cache-primary-key }}
