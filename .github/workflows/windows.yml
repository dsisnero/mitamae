name: Windows Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        target: [windows-x86_64, windows-i386]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Zig
      run: |
        $ZigVersion = "0.10.1"
        Invoke-WebRequest -Uri "https://ziglang.org/download/$ZigVersion/zig-windows-x86_64-$ZigVersion.zip" -OutFile zig.zip
        Expand-Archive -Path zig.zip -DestinationPath C:\zig
        echo "C:\zig\zig-windows-x86_64-$ZigVersion" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: Install dependencies
      run: |
        gem install rake

        # Install MinGW tools for strip command
        if ("${{ matrix.target }}" -eq "windows-x86_64") {
          choco install mingw -y --force
        } else {
          choco install mingw --x86 -y --force
        }

        # Install pkg-config for library detection
        # Use vcpkg to install pkgconf (provides pkg-config.exe)
        if (Test-Path "C:\vcpkg\vcpkg.exe") {
          if ("${{ matrix.target }}" -eq "windows-x86_64") {
            C:\vcpkg\vcpkg.exe install pkgconf:x64-windows
          } else {
            C:\vcpkg\vcpkg.exe install pkgconf:x86-windows
          }
          # Add vcpkg tools to PATH (contains pkgconf's pkg-config.exe)
          $vcpkgRoot = "C:\vcpkg"
          $toolsPath = Join-Path $vcpkgRoot "installed\${{ matrix.target == 'windows-x86_64' && 'x64-windows' || 'x86-windows' }}\tools\pkgconf"
          if (Test-Path $toolsPath) {
            echo "$toolsPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }
        } else {
          Write-Host "vcpkg not found, pkg-config may not be available"
        }

        # Install oniguruma for mruby-onig-regexp
        # Try vcpkg first, fall back to building from source if needed
        if (Test-Path "C:\vcpkg\vcpkg.exe") {
          if ("${{ matrix.target }}" -eq "windows-x86_64") {
            C:\vcpkg\vcpkg.exe install oniguruma:x64-windows
            $env:PKG_CONFIG_PATH = "C:\vcpkg\installed\x64-windows\lib\pkgconfig"
          } else {
            C:\vcpkg\vcpkg.exe install oniguruma:x86-windows
            $env:PKG_CONFIG_PATH = "C:\vcpkg\installed\x86-windows\lib\pkgconfig"
          }
        } else {
          Write-Host "vcpkg not found, trying Chocolatey..."
          choco install oniguruma -y --force 2>&1 | Out-Null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Oniguruma not available via package manager, mruby will bundle it"
          }
        }

    - name: Build mitamae
      env:
        MRUBY_YAML_USE_SYSTEM_LIBRARY: 1
        PKG_CONFIG_PATH: "C:/vcpkg/packages/oniguruma_${{ matrix.target == 'windows-x86_64' && 'x64-windows' || 'x86-windows' }}/lib/pkgconfig;C:/vcpkg/installed/${{ matrix.target == 'windows-x86_64' && 'x64-windows' || 'x86-windows' }}/lib/pkgconfig"
      run: |
        # Create junction on same drive to shorten paths for Windows command line limits
        $currentDir = (Get-Location).Path
        $drive = $currentDir.Substring(0, 1)
        $shortPath = "$drive`:\m"
        if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        New-Item -ItemType Junction -Path $shortPath -Target $currentDir

        try {
          # Build from shortened path to reduce command line length
          Set-Location $shortPath
          rake "release:build:${{ matrix.target }}"
        } finally {
          # Clean up junction
          Set-Location $currentDir
          if (Test-Path $shortPath) { Remove-Item $shortPath -Force -Recurse -ErrorAction SilentlyContinue }
        }

    - name: Test binary
      run: |
        $binary = if ("${{ matrix.target }}" -eq "windows-x86_64") { "mitamae-build\mitamae-x86_64-windows.exe" } else { "mitamae-build\mitamae-i386-windows.exe" }
        & $binary version

        # Test basic functionality
        & $binary local -l error - << 'EOF'
        execute 'test echo' do
          command 'echo Basic functionality test'
        end

        directory 'C:\mitamae_build_test' do
          action :create
        end

        file 'C:\mitamae_build_test\build_test.txt' do
          content 'Build test successful'
        end
        EOF

        # Clean up
        Remove-Item -Recurse -Force 'C:\mitamae_build_test' -ErrorAction SilentlyContinue

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mitamae-${{ matrix.target }}
        path: mitamae-build/mitamae-*-windows*.exe
